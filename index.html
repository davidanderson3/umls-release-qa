<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>UMLS Release QA</title>
  <link rel="stylesheet" href="css/styles.css">
</head>
<body>
  <div class="container">
    <h1>UMLS Release QA</h1>
    <div id="status"></div>
    <div id="sab-summary"></div>
    <button id="run-preprocess">Run Preprocessing</button>
    <div id="preprocess-results"></div>
    <button id="compare-lines">Compare Line Counts</button>
    <div id="line-results"></div>
  </div>

  <script type="module">
    async function checkReleases() {
      const status = document.getElementById('status');
      try {
        const resp = await fetch('/api/releases');
        if (!resp.ok) {
          status.innerHTML = `<p style="color:red">Failed to check releases: ${resp.status}</p>`;
          return;
        }
        const { current, previous, releaseList } = await resp.json();
        if (current && previous) {
          status.innerHTML = `
            <p>Current release: <strong>${current}</strong></p>
            <p>Previous release: <strong>${previous}</strong></p>
            <p style="color:green">Folders are ready for comparison.</p>
          `;
        } else {
          status.innerHTML = `
            <p style="color:red">Could not find at least two release folders.</p>
            <p>Please download the UMLS Metathesaurus Full Subset for the two latest releases and copy the complete contents after unzipping into the <code>releases</code> folder.</p>
          `;
        }
      } catch (err) {
        status.innerHTML = `<p style="color:red">Error checking releases: ${err.message}</p>`;
      }
    }
    checkReleases();

    async function loadSABSummary() {
      try {
        const resp = await fetch('/api/sab-diff');
        if (!resp.ok) return;
        const data = await resp.json();
        const { summary, current, previous } = data;
        if (!summary.length) return;
        let html = `<h3>SAB/TTY Differences (${current} vs ${previous})</h3>`;
        html += '<table><thead><tr><th>SAB</th><th>TTY</th><th>Previous</th><th>Current</th><th>Change</th><th>%</th></tr></thead><tbody>';
        for (const row of summary) {
          const style = row.Difference < 0 ? ' style="color:red"' : '';
          const pct = isFinite(row.Percent) ? row.Percent.toFixed(2) : 'inf';
          html += `<tr><td>${row.SAB}</td><td>${row.TTY}</td><td>${row.Previous}</td><td>${row.Current}</td><td${style}>${row.Difference}</td><td>${pct}</td></tr>`;
        }
        html += '</tbody></table>';
        document.getElementById('sab-summary').innerHTML = html;
      } catch {}
    }
    loadSABSummary();

    document.getElementById('run-preprocess').addEventListener('click', () => {
      const output = document.getElementById('preprocess-results');
      output.innerHTML = '<p>Running preprocessing...</p>';
      const es = new EventSource('/api/preprocess-stream');
      es.onmessage = (e) => {
        output.insertAdjacentHTML('beforeend', `<pre>${e.data}</pre>`);
      };
      es.addEventListener('done', () => {
        es.close();
        loadSABSummary();
      });
      es.onerror = () => {
        output.insertAdjacentHTML('beforeend', '<p style="color:red">Error running preprocessing.</p>');
        es.close();
      };
    });

    document.getElementById('compare-lines').addEventListener('click', async () => {
      const results = document.getElementById('line-results');
      results.innerHTML = '<p>Comparing...</p>';
      try {
        const resp = await fetch('/api/line-count-diff');
        if (!resp.ok) {
          results.innerHTML = `<p style="color:red">Failed: ${resp.status}</p>`;
          return;
        }
        const data = await resp.json();
        const { current, previous, files } = data;
        if (!files.length) {
          results.innerHTML = '<p>No files found.</p>';
          return;
        }
        let html = `<h3>Line Count Comparison (${current} vs ${previous})</h3>`;
        html += '<table><thead><tr><th>File</th><th>Previous</th><th>Current</th><th>Change</th></tr></thead><tbody>';
        const unchanged = [];
        for (const f of files) {
          const prev = f.previous ?? 0;
          const cur = f.current ?? 0;
          const diff = cur - prev;
          if (diff === 0) {
            unchanged.push(f.name);
            continue;
          }
          const decrease = diff < 0 ? ' style="color:red"' : '';
          html += `<tr><td>${f.name}</td><td>${prev}</td><td>${cur}</td><td${decrease}>${diff}</td></tr>`;
        }
        html += '</tbody></table>';
        if (unchanged.length) {
          html += `<p>Unchanged files: ${unchanged.join(', ')}</p>`;
        }
        results.innerHTML = html;
      } catch (err) {
        results.innerHTML = `<p style="color:red">Error: ${err.message}</p>`;
      }
    });
  </script>
</body>
</html>
