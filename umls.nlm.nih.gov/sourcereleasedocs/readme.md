# Building UMLS Vocabulary Documentation

In November 2017, we began deploying UMLS vocabulary documentation using JBake and Bamboo instead of Teamsite. The basic process is as follows:

JBake takes a set of HTML files and templates and bakes them into a static website. These files are located in the jbake folder of this repository. We can stage this static website locally using Eclipse. Some documentation is available here for staging websites locally using JBake: https://wiki.nlm.nih.gov/confluence/display/UMLS/Setting+up+a+jbake+documentation+area

Go through this checklist for each release:

## EDITING WEB CONTENT FOR THE NEXT RELEASE (Inverters)

Inverters create a folder named for the release (for example, 2018AA). Within that folder, create a folder named for the SAB being updated (for example, CPT). They should edit the html within the files, but ignore the header and menu content. Once the files are edited, they can be merged with the content in the jbake/content folder by running the following command:

bash scripts/syncLatestVersion.sh

## PREPARING THE NEXT RELEASE

A few things need to happen before the content can be deployed. New stats.html files must be generated. New metadata.html files must be generated. The SABs and SSNs must be updated. Dates must be updated. Menus may need to be updated. Page titles may need to be updated. New directories must be created. 

Do not edit any shell script files on Windows. Edit them on a Mac or in Cygwin. Editing them on Windows may give you line break issues. Feel free to find a fix for this. If line breaks are introduced, these instructions can be used to fix: https://its.ucsc.edu/unix-timeshare/tutorials/clean-ctrl-m.html.

Before doing anything, make a new branch from the develop branch. Name it after the release. For example: develop-2018AA-release.

## UPDATE VARIABLES

There is a variable $UPDATEDATE in scripts/replaceUpdatedDate.sh. This should be updated to match the release date. 

## GENERATING NEW STATS.HTML FILES

For nearly every vocabulary, the information in stats.html will change. These can be generated by a UMLS developer (Sravan has done it in the past). See the following JIRA ticket: https://jira.nlm.nih.gov/browse/UMLS-312. In the future - ask OCCS to deploy this to the versioned directory (for example, 2018AA). 

## FINALIZE RELEASE CONTENT

Check to make sure the release folder (ex, /2018AA) is finalized and ready to be synced with existing content. 

## UPDATING MRSAB.RRF

The repository contains a copy of MRSAB.RRF. This should be taken from the latest release. This can be retrieved from /umls_s/dist_root/{version}/RRF_usr/META once the release is ready, ordinarily the first Wednesday or Thursday of April or October. Copy this file to the root directory of this repository, overwriting the existing file.

## UPDATING NEW CONTENT, METADATA.HTML FILES, TITLES, DATES, MENUS

Once the previous steps have been completed, you can run the following script to update everything. Again, make sure the variables are set properly. 

bash scripts/generate_all.sh

This will run a set of scripts in a particular order. These scripts can also be run individually if necessary. The order is important. The process_mrsab.py script uses MRSAB.RRF to generate metadata.html files. The semicolon.sh script removes semicolons from the metadata.html files. The replaceSourceTitle.sh script users MRSAB.RRF to generate titles for each file based on the RSAB and SSN from MRSAB.RRF. The replaceMenu.sh script completely removes the existing menus on every page and then replaces them with new menus based on the files present in the directory. This is necessary because of menus vary from vocabulary to vocabulary depending on the pages available. Treat this script with care. The replaceUpdatedDate.sh script replaces the updated date for each page on the site. For simplicity, every page should get a date that matches the release date, even if that page wasnâ€™t updated specifically. 

Check the comments in individual script files for more information on their use. 

Once this process is done, the site should be ready for release. Run the site locally and QA it extensively. Use the qapage.html file to quickly link to vocabulary pages. For best results, load qapage.html in Chrome or another standard browser. Look especially at new content to make sure that it updated properly. Make sure that there are no problems with menus. Check dates. Scripts will not necessarily give useful errors. 

## UPDATING THE HOMEPAGE IN TEAMSITE

The generate_all.sh script includes a perl script (getSources.pl) that makes xml for the vocabulary documentation homepage (https://www.nlm.nih.gov/research/umls/sourcereleasedocs/index.html). It also includes a saxon command that transforms the xml to html using the index.xsl file. This produces a file called home.html. The contents of this file can be copied into Teamsite. QA this carefully before publishing it. 

## DEPLOYING TO THE WEB

Once you are comfortable with the release in your local branch, merge the changes into the develop branch. Test again. Then merge the changes into the master branch. Deploy using Bamboo here: (https://cis.nlm.nih.gov/browse/UDOC-UTSSRC). 