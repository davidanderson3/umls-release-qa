In November 2017, we began deploying vocabulary documentation using JBake and Bamboo instead of Teamsite. The basic process is as follows. 

JBake takes a set of HTML files and templates and bakes them into a static website. These files are located in the jbake folder of this repository. We can stage this static website locally using Eclipse. Some documentation is available here for staging websites locally using JBake: https://wiki.nlm.nih.gov/confluence/display/UMLS/Setting+up+a+jbake+documentation+area

Go through this checklist for each release:

EDITING WEB CONTENT FOR THE NEXT RELEASE (Inverters)

Inverters create a folder named for the release (for example, 2018AA). Within that folder, create a folder named for the SAB being updated (for example, CPT). Copy only the files to be edited from the jbake/content/{SAB} folder to the folder just created. Edit the html within the files, but ignore the header and menu content.

PREPARING THE NEXT RELEASE

A few things need to happen before the files can be released. New stats.html files must be generated. New metadata.html files must be generated. The SABs and SSNs must be updated. Dates must be updated. Menus may need to be updated. Page titles may need to be updated. New directories must be created. 

GENERATING NEW STATS.HTML FILES

For nearly every vocabulary, the information in stats.html will change. These can be generated by a UMLS developer. See the following JIRA ticket: https://jira.nlm.nih.gov/browse/UTS-343

GENERATING NEW METADATA.HTML FILES



UPDATING SABS AND SSNS (DO THIS FIRST)

There is a file called directorymap.txt where the SAB, directory name and SSN are maintained in a pipe-delimited table. This table was created manually, but it could be automated in some way in the future. If any of the SABs or SSNs were changed or new ones were added, this file must be updated to reflect the changes. 

NOTES ON USING SCRIPTS

These scripts can be used to update metadata and menus.

scripts/replaceUpdatedDate.sh
scripts/replaceDate.sh
scripts/replaceSourceTitle.sh
scripts/replaceMenu.sh

As of November 2017, these scripts are somewhat brittle and should be used with care. They only work in Cygwin, and not on Mac. The best way to update them is to edit them in a text editor in Cygwin. Ending them in a Windows editor like Notepad ++ may introduce line breaks that will break the scripts. If line breaks are introduced, these instructions can be used to fix: https://its.ucsc.edu/unix-timeshare/tutorials/clean-ctrl-m.html.

UPDATING DATES

JBake has two dates - a create date and an updated date. These scripts can be used to update the dates recursively in a set of folders:

scripts/replaceUpdatedDate.sh
scripts/replaceDate.sh

These scripts are dependent upon directorymap.txt being up to date. Update this first. These scripts only work if jbake metadata fields are present:

title=
date=
updated=
type=page
status=published
~~~~~~

The scripts/replaceDate.sh script operates on the “date=“ field. These dates could not be brought over from Teamsite, so they were set to 2017-11-06. For existing pages, they can keep this date. For new pages, this date should reflect the date of the page will be first released to the public. Check for new pages before copying anything from the versioned folders where the inverters work. Update the date field for these pages. 

The scripts/replaceUpdatedDate.sh operates on the “updated=“ field. This date should reflect the date that the page is updated for public consumption. For pages updated for 2018AA, this should be the 2018AA release date.

These scripts do need to be modified in order to work properly. Be sure to understand how they work before using them. 

UPDATING /JBAKE/CONTENT/ FOLDER

Once the updated files are finished, copy the folders to the /jbake/content/folder. The site can then be previewed by running JBake locally in Eclipse. See: https://wiki.nlm.nih.gov/confluence/display/UMLS/Setting+up+a+jbake+documentation+area. Next, update the titles and menus. 

UPDATING TITLES

scripts/replaceTitle.sh

This script uses directorymap.txt to update page titles. Make sure directorymap.txt is up to date before running it. It concatenates the SAB and SSN based on the directory name and then appends “Synopsis” or “Metadata”, depending on what page it is operating on. Run this upon each release to ensure each page has the correct title. 

UPDATING MENUS

scripts/replaceMenu.sh

This script updates the menus. It relies on the <!--menu--> <!--end menu--> tags to operate on the menu. The script deletes the existing menu entirely and replaces it with a new one. It looks for specific files (index.html, stats.html, etc) and creates a menu link if those files exist in a given directory. This script will not work if the <!--menu--> <!--end menu--> tags are missing, so these must remain intact. Run this upon each release to ensure each page has the correct menu. 

DEPLOYING TO THE WEB

All work is done in the develop branch. Once a release is ready, merge the changes into the master branch (https://git-scm.nlm.nih.gov/projects/UTS/repos/umlsdoc/browse). Deploy using Bamboo here: (https://cis.nlm.nih.gov/browse/UDOC-UTSSRC). 